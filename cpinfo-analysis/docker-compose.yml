services:
  cpinfo-analysis-official:
    image: cpinfo-analysis-official-mcp:latest
    container_name: cpinfo-analysis-official
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NPM_REGISTRY: "${NPM_REGISTRY:-https://registry.npmjs.org/}"
        JFROG_MCP_ACCESS_TOKEN: "${JFROG_MCP_ACCESS_TOKEN:-}"
    ports:
      - "${CPINFO_PUBLISHED_PORT:-3006}:${CPINFO_TRANSPORT_PORT:-3006}"
    environment:
      MCP_TRANSPORT_TYPE: "${MCP_TRANSPORT_TYPE:-http}"
      MCP_HTTP_PORT: "${CPINFO_TRANSPORT_PORT:-3006}"
      MCP_PUBLISHED_PORT: "${CPINFO_PUBLISHED_PORT:-3006}"
      MCP_PACKAGE_NAME: "@chkp/cpinfo-analysis-mcp"
      PORT: "${CPINFO_TRANSPORT_PORT:-3006}"
      CPINFO_CACHE_TTL_MS: "${CPINFO_CACHE_TTL_MS:-10800000}"
      DEBUG: "${DEBUG:-false}"
    volumes:
      - ./docker-entrypoint.sh:/usr/local/bin/docker-entrypoint.sh:ro
      - "${CPINFO_DATA_PATH:-./cpinfo-files}:/data:ro"
    entrypoint: ["/usr/local/bin/docker-entrypoint.sh"]
    command: ["npx", "@chkp/cpinfo-analysis-mcp"]
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('net').createConnection({host:'127.0.0.1', port: process.env.MCP_HTTP_PORT||3006}).on('connect',()=>process.exit(0)).on('error',()=>process.exit(1))"
        ]
      interval: 20s
      timeout: 3s
      retries: 6
      start_period: 10s
