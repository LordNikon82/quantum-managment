services:
  management-logs-official:
    image: management-logs-official-mcp:latest
    container_name: management-logs-official
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3002:3002"
    environment:
      MCP_TRANSPORT_TYPE: "http"
      MCP_HTTP_PORT: "3002"
      PORT: "3002"
      MCP_PACKAGE_NAME: "@chkp/management-logs-mcp"
      TOOL_PREFIX: "logs__"
      # === Target management ===
      MANAGEMENT_HOST: "${MANAGEMENT_HOST}"         # e.g. 192.168.2.230
      MANAGEMENT_PORT: "${MANAGEMENT_PORT:-443}"
      # === Secrets ===
      API_KEY_FILE: "/run/secrets/cp_api_key"
      # Turn off debug in production:
      DEBUG: "${DEBUG:-false}"
    secrets:
      - cp_api_key
    # Mount the entrypoint script into the image so no Dockerfile patch is needed
    volumes:
      - ./docker-entrypoint.sh:/usr/local/bin/docker-entrypoint.sh:ro
    entrypoint: ["/usr/local/bin/docker-entrypoint.sh"]
    command: ["npx","@chkp/management-logs-mcp","--transport-port","3002"]
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('net').createConnection({host:'127.0.0.1', port: process.env.MCP_HTTP_PORT||3002}).on('connect',()=>process.exit(0)).on('error',()=>process.exit(1))"
        ]
      interval: 20s
      timeout: 3s
      retries: 6
      start_period: 10s

secrets:
  cp_api_key:
    file: ./secrets/cp_api_key.txt
